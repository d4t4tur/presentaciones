---
title: "Shiny para useRs que no usan R"
author:  "Direcci贸n Nacional de Mercados y Estad铆stica"
output:
  xaringan::moon_reader:
    seal: false
    css: ["footer_header.css","dnmye_theme.css", "col_width.css"]
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
---

class:inverse, middle

background-image: url(imgs/escudo_mintur_blanco.png)
background-position: 95% 95%
background-size: 30%

.pull-left[
##  LatinR 2023
<br>
<br>
<br>
]
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>



### Shiny para useRs que no usan R

<br>
<br>
<br>
<br>


#### Direcci贸n Nacional de Mercados y Estad铆stica<br>Subsecretar铆a de Desarrollo Estrat茅gico


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(xaringanExtra)

# LOGO COLOR EN PAGs INTERNAS
xaringanExtra::use_logo(image_url = "imgs/escudo_mintur_color.png", 
                        position = css_position(top = "1em", right = "1em"), 
                        height = "20%", width = "20%")

# BARRA DE PROGRESO DE PRESENTACION
xaringanExtra::use_progress_bar(color = comunicacion::dnmye_colores("cian"))

# LAPIZ 
xaringanExtra::use_scribble()

# EXPLORADOR DE SLIDES
xaringanExtra::use_tile_view()

# HABILITAR WEBCAM
xaringanExtra::use_webcam()


```

```{r dnmye_theme, eval=FALSE, warning=FALSE, include=FALSE}

library(xaringanthemer)
library(comunicacion)


style_mono_light(outfile = "dnmye_theme.css", # CSS FILE
                 # FONTS
                  header_font_google = google_font('Encode Sans'),
                  text_font_google   = google_font('Roboto'),
                  code_font_google   = google_font('IBM Plex Mono'),
                 # COLORES 
                 base_color = dnmye_colores("cian"),
                 code_inline_color = dnmye_colores("rosa"), 
                 inverse_link_color = "#3B4449",
                 background_color = "#FFFFFF",
                 title_slide_background_image = "imgs/escudo_mintur_blanco.png", 
                 title_slide_background_position = "95% 5%", 
                 title_slide_background_size = "200px", footnote_color = "#3B4449", link_color = "3B4449",text_slide_number_font_size = "16px"
                  
                 )
```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, fig.height=3.5, fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  fig.show = TRUE,
  hiline = TRUE
)
```

---
layout: true

<div class="my-footer"><span>DIRECCIN NACIONAL DE MERCADOS Y ESTADSTICA <a href="https://yvera.tur.ar/sinta"> - <b>www.yvera.tur.ar/sinta</a></b></span></div> 

---

![](imgs/utdt/roceta.png)
---
###  [Conociendo a las estrellas del universo R](https://ropensci.org/es/blog/2022/11/23/r-universe-stars-1-es/)

 ![](imgs/ropensci_tuq.png)

---
## App

### Problem谩tica

- La Direcci贸n Nacional de Agencias de Viajes tiene como funci贸n principal registrar y controlar la actividad de las agencias de viajes. El trabajo manual genera demoras excesivas haciendo ineficiente el seguimiento y administraci贸n de los tr谩mites.

--

### Propuesta

- Dise帽ar una `Shiny App` que baje el costo de procesamiento de la documentaci贸n y acelere la gesti贸n de control necesaria.

- Utilizable por users sin conocimiento de `R`.

- *Software* basado en c贸digo abierto, libre y gratuito aplicado a la gesti贸n p煤blica.

---
## Funcionamiento

<br>

- Carga de archivos `.pdf` y `.xlsx`: p贸liza, declaraci贸n jurada y registro interno

- Identificaci贸n de campos claves

- Comparaci贸n de campos

- Notificaci贸n al user

- Exploraci贸n de los campos

---

## Interfaz

![](imgs/app_polizas1.png)

---

class:inverse, middle

#` Shiny App`: M贸dulos

---

## P贸liza

<br>

1) Levantar el PDF

```
fileInput(inputId = ns("poliza"), label = "Poliza", accept = ".pdf")
```
--

2) Identificar la aseguradora

 - Existen m煤ltiples aseguradoras con distintos formatos de registro por lo que se realizaron m贸dulos espec铆ficos para las m谩s importantes.
 
--

3) Ejecutar el m贸dulo *ad hoc*

```
file <- input$poliza

check <- pdftools::pdf_text(file) %>% limpieza()

      if (str_detect(check, "Aseguradora1")) {

        source("modules/poliza_aseguradora1.R", encoding = "UTF-8")

        poliza_df <- poliza_aseguradora1(file$datapath)

      } else if (...){
        ...
      }
    
```
---

## M贸dulo p贸liza

<br>

4) Extraer campos de control: `regex`

- Ejemplo:

```
  ### datos
  datos_asegurado <- str_extract(poliza, "(?<=asegura a:).*(?=obligado a efectuarle:)")

  ### nombre
  nombre_asegurado <- str_extract(datos_asegurado, ".*(?=CUIT)")
  
  ### codigo postal
  patron_cp <- "(?<=CP\\().{4,8}(?=\\))"
  cp <- str_extract(datos_asegurado, patron_cp)
  
```
---

## M贸dulo p贸liza

<br>

5) Armar tabla de salida

- 14 campos

```
df_poliza <- tibble(legajo, cuit, designacion_comercial, 
razon_social, categoria, domicilio, 
cp, suma_num, fecha_inicio_corta, 
fecha_fin_corta, if_poliza, nombre_asegurado, 
cuit_mintur, domicilio_mintur)

return(df_poliza)

```
---

## Declaraci贸n Jurada

<br>

1) Levantar el PDF

```
fileInput(inputId = ns("djc"), label = "Declaracion Jurada C", accept = ".pdf")
```
--

2) Ejecutar 煤nico m贸dulo

 - Identificar local virtual vs f铆sico
 - Identificar persona jur铆dica vs f铆sica

--

3) Extraer campos de control: `regex`

--

4) Armar tabla de salida (+30 campos)

---

## RLM

*RLM: Registro Legajo Multiprop贸sito

1) Levantar excel de registro

```
fileInput(inputId = ns("rlm"), label = "RLM", accept = c(".xlsx",".xls"))
```
--

2) Filtrar agencia y seleccionar campos

--

3) Armar tabla de salida
```
rlm_df <- reactive({

      rlm <- read_excel(file$datapath) %>%
        janitor::clean_names() %>%
        filter(legajo == Legajo) %>%
        select(legajo, categoria, designacion_comercial 
               razon_social, cuit, apellido, nombre,
               matricula, prefijo, telefono, mail)

    })

    return(list(data_rlm = reactive(rlm_df())))
    
```

---

## Chequeos

<br>

### Pesta帽a **P贸lizas - DD JJ**

- P贸liza vs Declaraci贸n Jurada


### Pesta帽a **RLM - DD JJ**

- RLM vs Declaraci贸n Jurada


```
#Ejemplo de chequeo
check_legajo <- df_poliza()$legajo == df_djc()$legajo
```

---

## P贸liza vs Declaraci贸n Jurada

![](imgs/app_polizas2.png)

---
## RLM vs Declaraci贸n Jurada

![](imgs/app_polizas4.png)
---

<br>

Adem谩s de los chequeos se ofrecen tablas interactivas para explorar los campos

<br>

![](imgs/app_polizas3.png)

---

class:inverse, middle

#隆La app funciona!

#...

--

#Pero, 驴c贸mo la disponibilizamos?

---

## De shiny a escritorio

<br>

### Obst谩culos

- Users sin conocimiento de R

--

- Escalabilidad: m煤ltiples users

--

- Servidor limitado

---

## De shiny a escritorio

<br>

### Caracter铆sticas

#### Encapsulamiento: [`DesktopDeployR`](https://github.com/wleepang/DesktopDeployR)

 ##### - No requiere instalaciones (`R` portable)

 ##### - Se comparte un archivo `.zip`

--

#### Acceso directo

 ##### - El user descomprime el archivo y solo hace doble *click* en el ejecutable

--

####  Funciona (solo) en *Windows*

---
class:inverse, middle

## La app result贸 en un proceso mucho m谩s eficiente que el flujo de trabajo manual, reduciendo en tres meses el per铆odo de procesamiento!!!

---

class:inverse, middle

background-image: url(imgs/escudo_mintur_blanco.png)
background-position: 95% 80%
background-size: 25%

## Gracias! 

https://www.yvera.tur.ar/sinta/

https://github.com/dnme-minturdep
